# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–∏–≥—Ä–∞—Ü–∏–π

## [0001] - 2024-11-07 - init

### –î–æ–±–∞–≤–ª–µ–Ω–æ
- ‚ú® –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚ú® –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `bot_users` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram
- ‚ú® –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `readings` –¥–ª—è –∑–∞–ø–∏—Å–µ–π —á—Ç–µ–Ω–∏–π/—Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ú® –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `steps` –¥–ª—è —à–∞–≥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–æ–Ω–±–æ—Ä–¥–∏–Ω–≥, –æ–±—É—á–µ–Ω–∏–µ, –æ–ø—Ä–æ—Å—ã)
- ‚ú® –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `questions` –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —à–∞–≥–∞–º–∏
- ‚ú® –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `payments` –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Yookassa

### –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
- üîó `readings.user_id` ‚Üí `bot_users.id` (ON DELETE CASCADE, ON UPDATE CASCADE)
- üîó `questions.step_id` ‚Üí `steps.id` (ON DELETE CASCADE, ON UPDATE CASCADE)
- üîó `payments.user_id` ‚Üí `bot_users.id` (ON DELETE CASCADE, ON UPDATE CASCADE)

### –ò–Ω–¥–µ–∫—Å—ã
- ‚ö° `idx_bot_users_telegram_id` –Ω–∞ `bot_users.telegram_id`
- ‚ö° `idx_bot_users_username` –Ω–∞ `bot_users.username` (partial)
- ‚ö° `idx_bot_users_created_at` –Ω–∞ `bot_users.created_at`
- ‚ö° `idx_readings_user_id` –Ω–∞ `readings.user_id`
- ‚ö° `idx_readings_status` –Ω–∞ `readings.status`
- ‚ö° `idx_readings_created_at` –Ω–∞ `readings.created_at` (DESC)
- ‚ö° `idx_readings_reading_type` –Ω–∞ `readings.reading_type`
- ‚ö° `idx_readings_payload_gin` –Ω–∞ `readings.reading_payload` (GIN –¥–ª—è JSONB)
- ‚ö° `idx_steps_order` –Ω–∞ `steps.step_order`
- ‚ö° `idx_steps_active` –Ω–∞ `steps.is_active` (partial)
- ‚ö° `idx_questions_step_id` –Ω–∞ `questions.step_id`
- ‚ö° `idx_questions_order` –Ω–∞ `questions(step_id, question_order)`
- ‚ö° `idx_questions_step_order_unique` –Ω–∞ `questions(step_id, question_order)` (UNIQUE)
- ‚ö° `idx_questions_options_gin` –Ω–∞ `questions.options` (GIN –¥–ª—è JSONB)
- ‚ö° `idx_payments_user_id` –Ω–∞ `payments.user_id`
- ‚ö° `idx_payments_status` –Ω–∞ `payments.status`
- ‚ö° `idx_payments_created_at` –Ω–∞ `payments.created_at` (DESC)
- ‚ö° `idx_payments_yookassa_id` –Ω–∞ `payments.yookassa_payment_id` (partial)
- ‚ö° `idx_payments_metadata_gin` –Ω–∞ `payments.metadata` (GIN –¥–ª—è JSONB)

### –¢—Ä–∏–≥–≥–µ—Ä—ã
- ‚è∞ `trigger_bot_users_updated_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at` –¥–ª—è `bot_users`
- ‚è∞ `trigger_steps_updated_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at` –¥–ª—è `steps`
- ‚è∞ `trigger_questions_updated_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at` –¥–ª—è `questions`
- ‚è∞ `trigger_payments_updated_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at` –¥–ª—è `payments`

### –§—É–Ω–∫—Ü–∏–∏
- üîß `update_updated_at_column()` - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- üîí `bot_users.telegram_id` - UNIQUE
- üîí `steps.step_order` - UNIQUE
- üîí `questions(step_id, question_order)` - UNIQUE
- üîí `payments.yookassa_payment_id` - UNIQUE
- üîí `payments.amount > 0` - CHECK constraint

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- üìù –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- üìù –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–º–µ—é—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- üìñ –°–æ–∑–¥–∞–Ω `README.md` —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
- üìñ –°–æ–∑–¥–∞–Ω `MIGRATION_SUMMARY.md` —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å–≤–æ–¥–∫–æ–π
- üìñ –°–æ–∑–¥–∞–Ω `SCHEMA_DIAGRAM.md` —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏ —Å—Ö–µ–º—ã
- üìñ –°–æ–∑–¥–∞–Ω `INDEX.md` –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- üìñ –°–æ–∑–¥–∞–Ω `.apply_migration.sh` —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (IF NOT EXISTS –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤)
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å (BEGIN...COMMIT)
- ‚úÖ –ö–∞—Å–∫–∞–¥–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å JSONB
- ‚úÖ –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–¢–∞–±–ª–∏—Ü:** 5
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 18 (–≤–∫–ª—é—á–∞—è 3 GIN –∏ 2 partial)
- **–í–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π:** 3
- **–¢—Ä–∏–≥–≥–µ—Ä–æ–≤:** 4
- **–§—É–Ω–∫—Ü–∏–π:** 1
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π:** 5 (4 UNIQUE + 1 CHECK)
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** 281

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–± (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
./migrations/.apply_migration.sh

# –†—É—á–Ω–æ–π —Å–ø–æ—Å–æ–±
psql $DATABASE_URL -f migrations/0001_init.sql
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
psql $DATABASE_URL -c "\dt"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
psql $DATABASE_URL -c "\di"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã
psql $DATABASE_URL -c "SELECT trigger_name, event_object_table FROM information_schema.triggers WHERE trigger_schema = 'public';"
```

---

## –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–µ–π

–ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å—å –≤ —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É —Ñ–æ—Ä–º–∞—Ç—É:

```markdown
## [XXXX] - YYYY-MM-DD - –ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### –î–æ–±–∞–≤–ª–µ–Ω–æ
- –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ò–∑–º–µ–Ω–µ–Ω–æ
- –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

### –£–¥–∞–ª–µ–Ω–æ
- –û–ø–∏—Å–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
\```bash
# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
\```
```

---

## –°–ª–µ–¥—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏, –æ–±–Ω–æ–≤–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª:

1. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Å–µ–∫—Ü–∏—é –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ (–ø–æ—Å–ª–µ —Ä–∞–∑–¥–µ–ª–∞ [0001])
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏ (0002, 0003, –∏ —Ç.–¥.)
3. –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è
4. –ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
5. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
6. –û–±–Ω–æ–≤–∏—Ç–µ –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–µ–∫—Ç–∞

---

## –°—Å—ã–ª–∫–∏

- [README.md](README.md) - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é
- [MIGRATION_SUMMARY.md](MIGRATION_SUMMARY.md) - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞ —Ç–µ–∫—É—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
- [SCHEMA_DIAGRAM.md](SCHEMA_DIAGRAM.md) - –í–∏–∑—É–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [INDEX.md](INDEX.md) - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- [0001_init.sql](0001_init.sql) - –§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏
