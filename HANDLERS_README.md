# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –±–æ—Ç–∞

## –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –∫–æ–º–∞–Ω–¥ Telegram –±–æ—Ç–∞ –Ω–∞ Aiogram 3.x. –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç:

- ‚úÖ –†—É—Å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–Ω–æ–ø–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –ë–î PostgreSQL
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
src/handlers/
‚îú‚îÄ‚îÄ __init__.py          # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ commands.py          # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (/start, /help, /cancel)
‚îú‚îÄ‚îÄ scenarios.py         # –ö–æ–º–∞–Ω–¥—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (/read)
‚îî‚îÄ‚îÄ admin.py            # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (commands.py)

### /start

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, –≤—ã–≤–æ–¥ –±–∞–ª–∞–Ω—Å–∞

**–§—É–Ω–∫—Ü–∏—è:** `cmd_start(message: types.Message, bot: Bot)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `bot_users`)
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
4. –ü–æ–ª—É—á–∞–µ—Ç –±–∞–ª–∞–Ω—Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∏ –ø–ª–∞—Ç–Ω—ã—Ö —á—Ç–µ–Ω–∏–π
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –±–∞–ª–∞–Ω—Å–æ–º

**–°–æ–æ–±—â–µ–Ω–∏—è:**
- –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {first_name}! –í–∞—à –∞–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω."`
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π: `"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ, {first_name}!"`
- –ë–∞–ª–∞–Ω—Å: `"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å:\nüî∑ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —á—Ç–µ–Ω–∏—è: {n}\nüíé –ü–ª–∞—Ç–Ω—ã–µ —á—Ç–µ–Ω–∏—è: {n}"`

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
[INFO] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –∑–∞–ø—É—Å—Ç–∏–ª /start
[INFO] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1 (123456789)
[INFO] –ü–æ–ª—É—á–µ–Ω –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1: –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ=0, –ø–ª–∞—Ç–Ω—ã–µ=0
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –ï—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ERROR_MESSAGE`
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É: `[ERROR] –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ /start: ...`

### /help

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º

**–§—É–Ω–∫—Ü–∏—è:** `cmd_help(message: types.Message)`

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:

/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/cancel - –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
```

### /cancel

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

**–§—É–Ω–∫—Ü–∏—è:** `cmd_cancel(message: types.Message)`

**–°–æ–æ–±—â–µ–Ω–∏–µ:** `"‚èπÔ∏è –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."`

## –ö–æ–º–∞–Ω–¥—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (scenarios.py)

### /read [payload]

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å —à–∞–≥–∞–º–∏ –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏

**–§—É–Ω–∫—Ü–∏—è:** `cmd_read(message: Message, bot: Bot)`

**–°–∏–Ω—Ç–∞–∫—Å–∏—Å:**
```
/read              # –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —Ç–∏–ø–∞ "default"
/read tarot        # –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —Ç–∏–ø–∞ "tarot"
/read astrology    # –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —Ç–∏–ø–∞ "astrology"
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç payload –∏–∑ –∫–æ–º–∞–Ω–¥—ã (—Ç–∏–ø —Å—Ü–µ–Ω–∞—Ä–∏—è)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `readings`
4. –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —à–∞–≥–æ–≤
5. –ù–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ:
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è —à–∞–≥–∞
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å `image_file_id:`)
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã —à–∞–≥–∞
   - –ñ–¥–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ `delay_sec:`)
6. –ü–æ—Å–ª–µ –≤—Å–µ—Ö —à–∞–≥–æ–≤ –ø–æ–º–µ—á–∞–µ—Ç —á—Ç–µ–Ω–∏–µ –∫–∞–∫ "completed"

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
[INFO] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –∑–∞–ø—É—Å—Ç–∏–ª /read —Å payload=tarot
[INFO] –ó–∞–ø—É—â–µ–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π 2 –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1
[INFO] –ù–∞—á–∏–Ω–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π: tarot
[INFO] –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ —à–∞–≥–∞ 1 (–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)
[INFO] –°—Ü–µ–Ω–∞—Ä–∏–π —á—Ç–µ–Ω–∏—è 2 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤

**Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:** `answer_question(callback_query: types.CallbackQuery)`

**Callback —Ñ–æ—Ä–º–∞—Ç:** `answer_<question_id>_<payload>`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ inline –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç `callback_query`
2. –†–∞–∑–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–æ–∫—É `callback_data`
3. –õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: `"‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç: {payload}"`

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
[INFO] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å 2: red
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫:**
- `skip_question()` - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞
- `answer_yes()` - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–∞"
- `answer_no()` - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–µ—Ç"

## –°–µ—Ä–≤–∏—Å —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (ScenarioService)

**–§–∞–π–ª:** `src/services/scenario_service.py`

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### `get_user_balance(user_id: int) -> Dict[str, int]`

–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∏ –ø–ª–∞—Ç–Ω—ã—Ö —á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    "free_readings": 5,
    "paid_readings": 2
}
```

#### `start_scenario(user_id: int, payload: Optional[str]) -> Optional[int]`

–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ –≤ –ë–î.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- `payload` - –¢–∏–ø —Å—Ü–µ–Ω–∞—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "tarot")

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** ID —á—Ç–µ–Ω–∏—è –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
[INFO] –°–æ–∑–¥–∞–Ω–æ —á—Ç–µ–Ω–∏–µ 1 –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1 —Ç–∏–ø–∞ tarot
```

#### `play_scenario_steps(user_id: int, chat_id: int, reading_id: int) -> bool`

–ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —à–∞–≥–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —à–∞–≥–∏ (is_active=TRUE)
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞:
   - –í—ã–∑—ã–≤–∞–µ—Ç `_play_step()`
   - –ñ–¥–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á—Ç–µ–Ω–∏—è –Ω–∞ "completed"
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** True –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, False –ø—Ä–∏ –æ—à–∏–±–∫–µ

#### `_play_step(chat_id: int, step, reading_id: int)`

–ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —à–∞–≥.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ `step.description` —Ñ–æ—Ç–æ (`image_file_id:`)
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è
4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã —à–∞–≥–∞

**–ü—Ä–∏–º–µ—Ä—ã –æ–ø–∏—Å–∞–Ω–∏—è —Å —Ñ–æ—Ç–æ –∏ —Ç–µ–∫—Å—Ç–æ–º:**
```
"–í–æ—Ç –Ω–∞—à–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è: image_file_id:AgADBAADXqcxG..."
"–¢–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ —Ñ–æ—Ç–æ image_file_id:AgADBAADXqcxG... | –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
```

#### `_handle_question(chat_id: int, question, reading_id: int)`

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–ø—Ä–æ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞.

**–¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤:**
- `text` - –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥
- `single_choice` - –í—ã–±–æ—Ä –æ–¥–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (inline –∫–Ω–æ–ø–∫–∏)
- `multiple_choice` - –í—ã–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (keyboard –∫–Ω–æ–ø–∫–∏)

#### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è

**–ú–µ—Ç–æ–¥—ã:**
```python
_extract_delay(description: str) -> int
# –ò–∑–≤–ª–µ–∫–∞–µ—Ç delay_sec:2 –∏–∑ —Å—Ç—Ä–æ–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 2

_extract_file_id(description: str) -> Optional[str]
# –ò–∑–≤–ª–µ–∫–∞–µ—Ç file_id –∏–∑ image_file_id:AgADBAADXqcxG...

_extract_text_before_image(description: str) -> str
# –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ image_file_id:
```

**–ü—Ä–∏–º–µ—Ä—ã –≤ –æ–ø–∏—Å–∞–Ω–∏–∏:**
```
"–≠—Ç–æ —Ç–µ–∫—Å—Ç | image_file_id:AgADBAADXqcxG... | delay_sec:2"

"image_file_id:AgADBAADXqcxG..."

"–¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ image_file_id:AgADBAADXqcxG..."
```

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã (admin.py)

### /get_photo_id

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ file_id –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

**–§—É–Ω–∫—Ü–∏—è:** `cmd_get_photo_id(message: types.Message)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º (`settings.admin_id`)
2. –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ADMIN_ONLY`
3. –ï—Å–ª–∏ –∞–¥–º–∏–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ

**–°–æ–æ–±—â–µ–Ω–∏—è:**
- –ê–¥–º–∏–Ω: `"üì∏ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è file_id"`
- –ù–µ-–∞–¥–º–∏–Ω: `"‚õî –≠—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"`

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ:** `handle_admin_photo(message: types.Message)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ñ–æ—Ç–æ –∏–∑ –º–∞—Å—Å–∏–≤–∞
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç `file_id`
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç file_id –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
```
üìã File ID —Ñ–æ—Ç–æ:
<code>AgADBAADXqcxG...</code>

–¢–∏–ø —Ñ–æ—Ç–æ: large
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
[INFO] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä 123456789 –∑–∞–ø—Ä–æ—Å–∏–ª /get_photo_id
[INFO] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä 123456789 –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ: AgADBAADXqcxG...
[INFO] File ID: AgADBAADXqcxG..., —Ä–∞–∑–º–µ—Ä: 12345 –±–∞–π—Ç
```

### /stats

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

**–§—É–Ω–∫—Ü–∏—è:** `cmd_stats(message: types.Message)`

**–í—ã–≤–æ–¥–∏—Ç:**
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:
üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 5
üìñ –í—Å–µ–≥–æ —á—Ç–µ–Ω–∏–π: 12
‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö: 12
‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ: 0
‚è∏Ô∏è –û—Ç–º–µ–Ω–µ–Ω–æ: 0
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
[INFO] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä 123456789 –∑–∞–ø—Ä–æ—Å–∏–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
[INFO] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
```

### /test_scenario

**–û–ø–∏—Å–∞–Ω–∏–µ:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

**–§—É–Ω–∫—Ü–∏—è:** `cmd_test_scenario(message: types.Message)`

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è...

üìñ –î–ª—è –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /read tarot
```

## –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

### `is_admin(user_id: int) -> bool`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ `settings.admin_id == 0` - –Ω–∏–∫—Ç–æ –Ω–µ –∞–¥–º–∏–Ω
- –ï—Å–ª–∏ `settings.admin_id > 0` –∏ `user_id == settings.admin_id` - –∞–¥–º–∏–Ω

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–î

### –¢–∞–±–ª–∏—Ü—ã

**bot_users:**
- `id` (PK) - ID –≤ –ë–î
- `telegram_id` (UQ) - Telegram ID
- `first_name` - –ò–º—è
- `last_name` - –§–∞–º–∏–ª–∏—è
- `username` - Username
- `is_bot` - –§–ª–∞–≥ –±–æ—Ç–∞
- `created_at` - –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
- `updated_at` - –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**readings:**
- `id` (PK)
- `user_id` (FK) - –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `reading_type` - –¢–∏–ø —Å—Ü–µ–Ω–∞—Ä–∏—è
- `reading_payload` (JSONB) - –î–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
- `status` - –°—Ç–∞—Ç—É—Å (pending, in_progress, completed, cancelled)
- `created_at`
- `updated_at`
- `completed_at`

**steps:**
- `id` (PK)
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ
- `description` - –û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å image_file_id:, delay_sec:)
- `step_order` (UQ) - –ü–æ—Ä—è–¥–æ–∫
- `is_active` - –ê–∫—Ç–∏–≤–µ–Ω –ª–∏
- `created_at`
- `updated_at`

**questions:**
- `id` (PK)
- `step_id` (FK)
- `question_text` - –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
- `question_type` - –¢–∏–ø (text, single_choice, multiple_choice)
- `options` (JSONB) - –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
- `question_order` - –ü–æ—Ä—è–¥–æ–∫
- `is_required` - –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –ª–∏
- `created_at`
- `updated_at`

## –§–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö

### –í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ (option) –¥–ª—è single_choice

```json
{
  "text": "–ö—Ä–∞—Å–Ω—ã–π",
  "payload": "red"
}
```

### –í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è multiple_choice

```json
{
  "text": "–°–ø–æ—Ä—Ç"
}
```

### –î–∞–Ω–Ω—ã–µ –≤ reading_payload

–ü—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤:
```json
{
  "answers": {
    "1": "–ò–≤–∞–Ω",
    "2": "red",
    "3": ["–°–ø–æ—Ä—Ç", "–ú—É–∑—ã–∫–∞"]
  }
}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–¢—Ä–µ–±—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env:**

```bash
BOT_TOKEN=<—Ç–µ–ª–µ–≥—Ä–∞–º_—Ç–æ–∫–µ–Ω>
ADMIN_ID=<–≤–∞—à_telegram_id>
DATABASE_URL=postgresql://user:password@localhost:5432/bot_db
```

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:**
```bash
LOG_LEVEL=DEBUG  # DEBUG, INFO, WARNING, ERROR, CRITICAL
DEBUG=True       # –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–æ—Ä–º–∞—Ç:**
```
%(asctime)s - %(name)s - %(levelname)s - %(message)s
```

**–ü—Ä–∏–º–µ—Ä:**
```
2024-01-15 10:30:45,123 - src.handlers.commands - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –∑–∞–ø—É—Å—Ç–∏–ª /start
```

**–£—Ä–æ–≤–Ω–∏:**
- `DEBUG` - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- `INFO` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ–ø–µ—Ä–∞—Ü–∏–∏)
- `WARNING` - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
- `ERROR` - –û—à–∏–±–∫–∏ (–æ—à–∏–±–∫–∏ –ë–î, –∏—Å–∫–ª—é—á–µ–Ω–∏—è)
- `CRITICAL` - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–æ—Ç–∫–∞–∑ —Å–∏—Å—Ç–µ–º—ã)

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç try-except –±–ª–æ–∫–∏:

```python
try:
    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞: {str(e)}")
    await message.answer(messages.ERROR_MESSAGE)
```

**–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:** `"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."`

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ—Å—Ç–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π

```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start
# –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å

# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /read tarot
# –ë–æ—Ç –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —à–∞–≥–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
```

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç file_id

```bash
# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /get_photo_id
# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ
# –ë–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç file_id –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —à–∞–≥–∞
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–≥–∞ —Å —Ñ–æ—Ç–æ

```sql
UPDATE steps 
SET description = '–≠—Ç–æ –≤–∞—à–∞ –∫–∞—Ä—Ç–∞: image_file_id:AgADBAADXqcxG...'
WHERE id = 1;
```

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ /read —Å—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ñ–æ—Ç–æ.

## –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤** - –°–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É
2. **FSM (Finite State Machine)** - –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏
3. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —à–∞–≥–æ–≤ –∏ –≤–æ–ø—Ä–æ—Å–æ–≤
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞** - –í–∏–¥–µ–æ, –∞—É–¥–∏–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã
5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - Email, SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —á—Ç–µ–Ω–∏—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–º. `HANDLERS_TESTING_PLAN.md` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–ª–µ–¥—É—é—Ç –µ–¥–∏–Ω—ã–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –†—É—Å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–î —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
